<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Ladang Chengal - Plantation and Agronomy Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .details-content { display: none; }
        .details-content.active { display: block; }
        .dropdown-btn.active { background-color: #14532d; }
        .policy-item { border-left: 3px solid #16a34a; padding-left: 1rem; margin-top: 0.75rem; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .chart-container { position: relative; height: 300px; width: 100%; margin: auto; }
        .pie-chart-container { position: relative; height: 350px; width: 100%; margin: auto; }
        .observation-ref { font-size: 0.75rem; color: #57534e; font-style: italic; }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-md">
        <nav class="container mx-auto px-6 py-4 flex items-center justify-between">
            <div class="text-xl font-bold text-gray-900">
                <a href="index.html" class="flex items-center">
                    Ladang Chengal Report
                </a>
            </div>
            <a href="estates.html" class="text-green-800 hover:text-green-900 transition duration-300">&larr; Back to Estates List</a>
        </nav>
    </header>

    <!-- Main container for the report -->
    <div class="container mx-auto p-4 md:p-8">
        <!-- Container where the estate data will be rendered -->
        <div id="selected-estate-container" class="grid grid-cols-1 gap-8">
             <!-- Content will be generated by JavaScript -->
        </div>
    </div>
    
    <!-- Modal for displaying policy details -->
    <div id="policyModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-2xl font-bold">Agricultural Policy Cross-Reference</h3>
                <button onclick="closePolicyModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="modalContent" class="space-y-4 overflow-y-auto pr-4 flex-grow">
                <!-- Modal content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Main script for application logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA STORE ---
            const estateData = {
                "id": "chengal",
                "name": "Ladang Chengal",
                "reportInfo": "Data based on Agronomy Report (Visit: 18th September 2025) & Plantation Advisory Report (Visit: 23 June 2025, Reviewed: Jan-May 2025).",
                "summaryMetrics": {
                    "area": {
                        "title": "Estate Area",
                        "lines": [
                            "Total Planted: 1,814.20 ha",
                            "Mature: 1,814.20 ha",
                            "Vacant/Unplantable: 374.80 ha"
                        ]
                    },
                    "yield": {
                        "title": "Yield/Ha (YTD Aug '25 vs '24)",
                        "value": "13.43 / 14.23 MT",
                        "note": "-6% vs 2024 (Source: AR)",
                        "valueColor": "text-red-700"
                    },
                    "cost": {
                        "title": "FFB Cost/Tonne (YTD May '25 vs Budget)",
                        "value": "RM 260.86 / RM 289.84",
                        "note": "10% lower than budget (Source: PAR)",
                        "valueColor": "text-green-700"
                    },
                    "manuring": {
                        "title": "Manuring Progress",
                        "value": "Delayed",
                        "note": "Mix A (64%), Mix B (70%) behind schedule.",
                        "valueColor": "text-yellow-700"
                    },
                     "pruning": {
                        "title": "Pruning Progress",
                        "value": "On Schedule",
                        "note": "2/3 rounds complete. Frond stacking needs improvement.",
                        "valueColor": "text-orange-700"
                    }
                },
                "keyMetrics": [
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-blue-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z' /></svg>", "label": "Labour Ratio", "value": "1:13 ha (Adequate)" },
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-red-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' /></svg>", "label": "P&D Status", "value": "High (Rats >10%)" },
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-green-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M13 10V3L4 14h7v7l9-11h-7z' /></svg>", "label": "OER % (YTD)", "value": "19.03%" },
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-red-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z' /></svg>", "label": "Harvester Prod.", "value": "1.79 MT/day (Moderate)" },
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-purple-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z' /></svg>", "label": "Harvest Interval", "value": "Inconsistent (>15 days)" },
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-teal-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17.657 18.343A8 8 0 016.343 7.029m11.314 11.314a8 8 0 01-11.314-11.314m2.121 13.435a2 2 0 01-2.828 0l-2.122-2.121a2 2 0 010-2.828l5.656-5.657a2 2 0 012.829 0l2.121 2.121a2 2 0 010 2.828l-5.657 5.657z' /></svg>", "label": "Nutrient Status", "value": "N & Mg Suboptimal" }
                ],
                "chartData": {
                    "production": {
                        "labels": ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug"],
                        "rainfall": [159.5, 90.0, 143.0, 470.5, 125.5, 128.5, 26.0, 153.5],
                        "ffb": [2378, 1883, 2576, 3136, 3399, 3185, 3626, 4185],
                        "note": "Rainfall & FFB Production data YTD August 2025. (AR Pg. 47, 56)"
                    },
                    "ageProfile": {
                        "labels": ["Prime Mature (8-19 yrs)", "Old Mature (>19 yrs)"],
                        "data": [65.18, 34.82],
                        "title": "Ladang Chengal - Palm Age Distribution",
                        "note": "*Source: Plantation Advisory Report 1/2025, Pg. 9."
                    }
                },
                "observations": [
                    "<b>Yield Performance:</b> Yield as of August 2025 is 6% lower than last year, averaging 13.43 MT/ha. This is linked to inconsistent harvesting intervals and upkeep delays. <span class='observation-ref'>(AR Pg. 46, PAR Pg. 37)</span>",
                    "<b>Critical Manuring & Upkeep Delays:</b> Manuring is significantly behind schedule, especially for sub-soil applications (Mix A 64%, Mix B 70%). The fertilizer store floor remains wet, an unresolved issue. This compounds PAR's findings of delayed weeding. <span class='observation-ref'>(AR Pg. 13, 15; PAR Pg. 17, 30)</span>",
                    "<b>Harvesting Standards & Productivity:</b> Harvesting intervals are inconsistent, frequently exceeding 15 days (up to 19 days). Harvester productivity is moderate at 1.79 MT/day. While loose fruit collection is now 'minimal', frond stacking quality is 'not fully satisfactory'. <span class='observation-ref'>(AR Pg. 18, 32, 48; PAR Pg. 33)</span>",
                    "<b>Pest Status (Rats):</b> Rat damage remains a concern, with several blocks exceeding the 10% threshold. The estate's baiting practices are not aligned with standard procedure (baiting in low-damage blocks). <span class='observation-ref'>(AR Pg. 41-43, PAR Pg. 28)</span>",
                    "<b>Field & Canopy Condition:</b> Pruning is on schedule (2/3 rounds complete), but frond stacking is messy and needs improvement. Mounding for leaning palms in low-lying areas is in progress. Mg deficiency symptoms are visible in some hilly areas. <span class='observation-ref'>(AR Pg. 22-24, 28, 32)</span>"
                ],
                "reports": {
                    "plantation": {
                        "Executive Summary": "Performance is acceptable with lower production costs, but FFB production is below budget. Key issues include low harvester productivity, delayed weeding and manuring, and the need to improve upkeep quality. (PAR Pg. 44-46)",
                        "Area Statement": "Total planted area is 1,814.20 ha, comprising 65.18% prime mature palms and 34.82% old mature palms. Unplantable and vacant areas total 374.80 ha. (PAR Pg. 9)",
                        "Labour Statement": "The workforce is adequate with a ratio of 1 worker to 13 ha. However, there is a shortage of 6 workers for manuring. Harvester productivity is low at 1.61 tons/man-day. (PAR Pg. 11-12)",
                        "Staff Establishment": "Staff complement is satisfactory with a supervisor ratio of 1:363 ha. Several transfers, a resignation, a retirement, and a new appointment occurred in the period. (PAR Pg. 13-14)",
                        "General Charges": "Expenditure is 23% lower than budget. Overspending occurred in Executive Travel, Manager's Bungalow Upkeep, SOCSO contributions, Labour Recruitment, Permit Renewals, and Assessment Tax, with justifications provided. (PAR Pg. 15-16)",
                        "Upkeep and Cultivation": "Expenditure is 23% below budget. Weeding, manuring, and pruning are behind schedule. Road maintenance is slow. (PAR Pg. 17, 44)",
                        "Harvesting and Collection": "Harvesting intervals are too long (up to 21 days). Harvesting standards need improvement regarding loose fruit collection and avoiding over-pruning. FFB quality is affected by unripe bunches and debris. (PAR Pg. 33-36)",
                        "Crop Production": "YTD May FFB production is 13,372.35 MT, which is 12% below budget and 14% below last year. Estate yield is 7.37 MT/ha. (PAR Pg. 37)",
                        "Production Cost": "FFB cost of production ex-estate (RM 260.86/tonne) is 10% lower than budget, mainly due to lower upkeep and cultivation costs. (PAR Pg. 41)",
                        "Vehicles Running Cost": "Cost for Tractor John Deere was 41% higher than the budget due to low running hours and repairs. Van cost was 20% higher due to repairs. (PAR Pg. 43)",
                        "Capital Expenditure": "No capital expenditure was incurred during the review period. (PAR Pg. 42)",
                        "Mechanization": "Mechanized infield collection covers 85% of the harvesting area. Productivity using Timac (2.05 tons/day) and Mini Crawler (2.15 tons/day) needs improvement. (PAR Pg. 39-40, 45)"
                    },
                    "agronomy": {
                        "Executive Summary": "Yield as of Aug 2025 is 6% lower than last year. Key issues are delays in sub-soil manuring, unresolved wet fertilizer store, inconsistent harvesting intervals, and rat damage requiring effective control. Pruning progress is acceptable, but frond stacking needs improvement. (Source: AR, Pg. 4-6, 46)",
                        "Nutrient Inputs/Progress of Manuring": "Manuring is behind schedule, with Mixture A at 64% and Mixture B at 70% complete. Delays are due to limited worker availability for sub-soil application. The fertilizer store floor remains wet, and excess fertilizer is stored outside under canvas. (Source: AR, Pg. 13-15)",
                        "Agronomic Observation": "Harvesting intervals are inconsistent, exceeding 15 days in most blocks (up to 19 days in P07C). Loose fruit collection is minimal. Pruning is on schedule (2/3 rounds complete), but frond stacking is poor. Circle weeding is slightly delayed. Rat damage exceeds 10% in several blocks. (Source: AR, Pg. 18, 28, 32, 35, 41)",
                        "Yield Performance": "Yield (YTD Aug 2025) is 13.43 MT/ha, a 6% reduction from 2024 (14.23 MT/ha). Production improved since March but was impacted by low rainfall in Q1 and harvester shortages. Average harvester productivity is 1.79 MT/day. (Source: AR, Pg. 46-48)",
                        "Fertilizer Recommendation": "The 2026 program is established, retaining the same blocks for subsoil application. GML is added to address Magnesium deficiency and low soil pH. (Source: AR, Pg. 52)"
                    },
                    "pinfosys": {
                        "summary": "Key Metrics (YTD May 2025): Total Income (N/A), Operating Profit (N/A), Cost of Production (RM 260.86/Tonne), Manuring Cost (RM 403.99/Ha), General Charges (RM 598.46/Ha). (PAR Pg. 15, 17, 41)",
                        "expenditure": [
                            { "category": "Upkeep & Cultivation", "item": "Weeding", "rm_ha": "115.12", "rm_tonne": "-" },
                            { "category": "Upkeep & Cultivation", "item": "Manuring", "rm_ha": "403.99", "rm_tonne": "-" },
                            { "category": "Upkeep & Cultivation", "item": "P&D", "rm_ha": "27.17", "rm_tonne": "-" },
                            { "category": "Upkeep & Cultivation", "item": "Road & Bridges", "rm_ha": "92.66", "rm_tonne": "-" },
                            { "category": "Upkeep & Cultivation", "item": "Pruning", "rm_ha": "63.98", "rm_tonne": "-" },
                            { "category": "Harvesting & Collection", "item": "Harvesting", "rm_ha": "-", "rm_tonne": "49.78" },
                            { "category": "Harvesting & Collection", "item": "Internal Transport", "rm_ha": "-", "rm_tonne": "29.83" }
                        ]
                    }
                },
                "policy": "<div class='policy-item'><p class='font-semibold'>Pest Control</p><p class='text-sm text-gray-600'><b>Policy Ref: P&D-Rat-01/02:</b> Rat damage in several blocks exceeds the 10% threshold, triggering baiting policy. However, the estate is not following procedure (e.g., baiting low-infestation areas), which is inefficient. (AR Pg. 41-43)</p></div><div class='policy-item'><p class='font-semibold'>Field Upkeep</p><p class='text-sm text-gray-600'><b>Policy Ref: FERT-APP-05:</b> The 2025 manuring program is significantly delayed, especially for sub-soil application, contravening policy. (AR Pg. 13)</p><p class='text-sm text-gray-600'><b>Policy Ref: WEED-STD-01:</b> Circle weeding is delayed, hindering operations. (PAR Pg. 17, 30)</p></div><div class='policy-item'><p class='font-semibold'>Harvesting Standards</p><p class='text-sm text-gray-600'><b>Policy Ref: HARV-INT-01:</b> Harvesting intervals consistently exceed 15 days, violating policy. (AR Pg. 18)</p></div>"
            };


            // --- GLOBAL VARIABLES ---
            let chartInstances = {};
            const container = document.getElementById('selected-estate-container');

            // --- FUNCTIONS ---
            function renderEstate() {
                container.innerHTML = createEstateHTML(estateData);
                setTimeout(() => {
                    initializeChartsForEstate(estateData);
                    populateInternalDropdowns(estateData);
                    attachEventListeners(estateData);
                }, 0);
            }

            function createEstateHTML(estate) {
                const summaryMetricsHTML = Object.values(estate.summaryMetrics).map(metric => {
                    const colorClass = metric.title.includes('Area') ? 'bg-blue-50 text-blue-800' : 
                                       metric.title.includes('Yield') ? 'bg-red-50 text-red-800' :
                                       metric.title.includes('Cost') ? 'bg-green-50 text-green-800' :
                                       metric.title.includes('Manuring') ? 'bg-yellow-50 text-yellow-800' : 'bg-orange-50 text-orange-800';
                    
                    if (metric.lines) {
                        // This is for the Area card
                        return `<div class="p-4 rounded-lg ${colorClass} h-full"><h3 class="font-semibold">${metric.title}</h3>${metric.lines.map(line => `<p class="text-sm">${line}</p>`).join('')}</div>`;
                    }

                    // New logic for "Actual / Budget" cards
                    let valueHTML;
                    if (metric.value.includes(' / ')) {
                        const parts = metric.value.split(' / ');
                        const actual = parts[0];
                        const budget = parts[1];
                        const valueColor = metric.valueColor || 'text-gray-900'; // Fallback color
                        
                        // Special handling for RM symbol
                        if (actual.startsWith('RM')) {
                             valueHTML = `
                                <p class="text-2xl font-bold ${valueColor}">
                                    ${actual}
                                    <span class="text-xl font-semibold text-gray-600">/ ${budget}</span>
                                </p>`;
                        } else {
                            // For Yield (e.g., "13.43 / 14.23 MT")
                            const budgetParts = budget.split(' ');
                            const budgetValue = budgetParts[0];
                            const budgetUnit = budgetParts.slice(1).join(' '); // "MT"
                             valueHTML = `
                                <p class="text-2xl font-bold ${valueColor}">
                                    ${actual}
                                    <span class="text-xl font-semibold text-gray-600">/ ${budgetValue} ${budgetUnit}</span>
                                </p>`;
                        }
                    } else {
                        // Fallback for simple value cards (like Manuring, Pruning)
                        const valueColor = metric.valueColor || 'text-gray-900';
                        valueHTML = `<p class="text-2xl font-bold ${valueColor}">${metric.value}</p>`;
                    }

                    return `
                        <div class="p-4 rounded-lg ${colorClass} h-full">
                            <h3 class="font-semibold">${metric.title}</h3>
                            ${valueHTML}
                            <p class="text-xs text-gray-500 mt-1">${metric.note}</p>
                        </div>`;
                }).join('');

                const keyMetricsHTML = estate.keyMetrics.map(metric => `
                    <div class="flex items-center space-x-3 bg-gray-50 p-3 rounded-lg">
                        <div class="bg-gray-100 p-2 rounded-full">${metric.icon}</div>
                        <div><p class="text-sm text-gray-500">${metric.label}</p><p class="font-bold text-lg">${metric.value}</p></div>
                    </div>`).join('');

                const observationsHTML = estate.observations.map(obs => `<li class="ml-4">${obs}</li>`).join('');

                return `
                    <div class="bg-white p-6 rounded-lg shadow-lg animate-fade-in">
                        <h2 class="text-3xl font-bold mb-2 text-gray-900">${estate.name}</h2>
                        <p class="text-sm text-gray-500 mb-6 italic">${estate.reportInfo}</p>
                        <div classag="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 mb-8">${summaryMetricsHTML}</div>
                        <div class="mb-8"><h3 class="text-xl font-semibold mb-4 border-b pb-2">Key Metrics & Agronomic Status</h3><div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-4">${keyMetricsHTML}</div></div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                            <div><h3 class="text-xl font-semibold mb-2">Monthly Production vs Rainfall (2025)</h3><div class="chart-container"><canvas id="prodChart-${estate.id}"></canvas></div><p class="text-xs text-center text-gray-500 mt-2">${estate.chartData.production.note}</p></div>
                            <div><h3 class="text-xl font-semibold mb-2">Palm Age Profile</h3><div class="pie-chart-container"><canvas id="ageChart-${estate.id}"></canvas></div><p class="text-xs text-center text-gray-500 mt-2">${estate.chartData.ageProfile.note}</p></div>
                        </div>
                        <div class="mb-8"><h3 class="text-xl font-semibold mb-2 border-b pb-2">Key Observations & Issues (Combined Reports)</h3><ul class="list-disc list-inside space-y-2 text-gray-700 mt-4">${observationsHTML}</ul></div>
                        <div class="mb-8 text-center"><button class="policy-modal-btn bg-green-800 text-white px-6 py-3 rounded-lg hover:bg-green-900 transition shadow-md">View Agricultural Policy Cross-Reference</button></div>
                        <div class="space-y-2">
                            <button data-dropdown-id="${estate.id}-plantation" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Plantation Advisory Report Details</button>
                            <div id="${estate.id}-plantation" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                            <button data-dropdown-id="${estate.id}-agronomy" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Agronomy Report Details</button>
                            <div id="${estate.id}-agronomy" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                            <button data-dropdown-id="${estate.id}-pinfosys" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Pinfosys / Financial Summary (from PA Report)</button>
                            <div id="${estate.id}-pinfosys" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                        </div>
                    </div>`;
            }

            function initializeChartsForEstate() {
                const prodCanvasId = `prodChart-${estateData.id}`;
                const ageCanvasId = `ageChart-${estateData.id}`;
                if (chartInstances[prodCanvasId]) chartInstances[prodCanvasId].destroy();
                if (chartInstances[ageCanvasId]) chartInstances[ageCanvasId].destroy();

                const prodCtx = document.getElementById(prodCanvasId)?.getContext('2d');
                if(prodCtx) {
                    chartInstances[prodCanvasId] = new Chart(prodCtx, {
                        type: 'bar',
                        data: {
                            labels: estateData.chartData.production.labels,
                            datasets: [
                                { 
                                    label: 'FFB Production (MT)', 
                                    data: estateData.chartData.production.ffb, 
                                    type: 'line', 
                                    borderColor: '#ca8a04', 
                                    backgroundColor: 'transparent', 
                                    yAxisID: 'y-ffb', 
                                    tension: 0.4 
                                },
                                { 
                                    label: 'Rainfall (mm)', 
                                    data: estateData.chartData.production.rainfall, 
                                    backgroundColor: '#3b82f6', 
                                    yAxisID: 'y-rainfall' 
                                }
                            ]
                        },
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false, 
                            scales: { 
                                x: { grid: { display: false } }, 
                                'y-ffb': { 
                                    type: 'linear', 
                                    position: 'left', 
                                    title: { display: true, text: 'FFB Production (MT)' } 
                                },
                                'y-rainfall': { 
                                    type: 'linear', 
                                    position: 'right', 
                                    title: { display: true, text: 'Rainfall (mm)' }, 
                                    grid: { drawOnChartArea: false } 
                                } 
                            } 
                        }
                    });
                }

                const ageCtx = document.getElementById(ageCanvasId)?.getContext('2d');
                if(ageCtx) {
                    chartInstances[ageCanvasId] = new Chart(ageCtx, {
                        type: 'pie',
                        data: {
                            labels: estateData.chartData.ageProfile.labels,
                            datasets: [{ data: estateData.chartData.ageProfile.data, backgroundColor: ['#16a34a', '#f59e0b'], hoverOffset: 4 }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: false }, legend: { position: 'right' } } }
                    });
                }
            }
            
            function populateInternalDropdowns() {
                const agronomyDiv = document.getElementById(`${estateData.id}-agronomy`);
                const plantationDiv = document.getElementById(`${estateData.id}-plantation`);
                const pinfosysDiv = document.getElementById(`${estateData.id}-pinfosys`);

                if (agronomyDiv && estateData.reports.agronomy) {
                    agronomyDiv.innerHTML = Object.entries(estateData.reports.agronomy).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section.replace(/([A-Z])/g, ' $1').trim()}:</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                }
                if (plantationDiv && estateData.reports.plantation) {
                    plantationDiv.innerHTML = Object.entries(estateData.reports.plantation).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section.replace(/([A-Z])/g, ' $1').trim()}:</h4><p class="text-sm text-gray-600">${content}</p>D`).join('');
                }
                if (pinfosysDiv && estateData.reports.pinfosys) {
                    const expenditureTable = `
                        <div class="overflow-x-auto mt-4">
                            <table class="min-w-full bg-white text-sm">
                                <thead class="bg-gray-200">
                                    <tr>
                                        <th class="py-2 px-4 text-left">Item</th>
                                        <th class="py-2 px-4 text-right">Cost (RM/Ha)</th>
                                        <th class="py-2 px-4 text-right">Cost (RM/Tonne)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${estateData.reports.pinfosys.expenditure.map(item => `
                                    <tr class="border-b">
                                        <td class="py-2 px-4 font-medium">${item.item} <span class="text-xs text-gray-500">(${item.category.split(' ')[0]})</span></td>
                                        <td class="py-2 px-4 text-right">${item.rm_ha}</td>
                                        <td class="py-2 px-4 text-right">${item.rm_tonne}</td>
                                    </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    pinfosysDiv.innerHTML = `<h4 class="font-semibold mt-2 text-gray-800">Key Metrics:</h4><p class="text-sm text-gray-600">${estateData.reports.pinfosys.summary}</p><h4 class="font-semibold mt-4 text-gray-800">Expenditure Breakdown:</h4>${expenditureTable}`;
                }
            }

            function attachEventListeners() {
                container.querySelectorAll('.dropdown-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const id = event.currentTarget.dataset.dropdownId;
                        const content = document.getElementById(id);
                        content.classList.toggle('active');
                        event.currentTarget.classList.toggle('active');
                    });
                });
                container.querySelector('.policy-modal-btn')?.addEventListener('click', () => openPolicyModal(estateData));
            }

            renderEstate();
        });
        
        function openPolicyModal(estate) {
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            modalTitle.innerText = `Agricultural Policy Cross-Reference: ${estate.name}`;
            modalContent.innerHTML = estate.policy;
            document.getElementById('policyModal').classList.add('active');
        }

        function closePolicyModal() {
            document.getElementById('policyModal').classList.remove('active');
        }
    </script>
</body>
</html>

