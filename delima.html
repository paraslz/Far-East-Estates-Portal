<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Ladang Delima - Plantation and Agronomy Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .details-content { display: none; }
        .details-content.active { display: block; }
        .dropdown-btn.active { background-color: #14532d; }
        .policy-item { border-left: 3px solid #16a34a; padding-left: 1rem; margin-top: 0.75rem; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .chart-container { position: relative; height: 300px; width: 100%; margin: auto; }
        .pie-chart-container { position: relative; height: 350px; width: 100%; margin: auto; }
        .observation-ref { font-size: 0.75rem; color: #57534e; font-style: italic; }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-md">
        <nav class="container mx-auto px-6 py-4 flex items-center justify-between">
            <div class="text-xl font-bold text-gray-900">
                <a href="index.html" class="flex items-center">
                    Ladang Delima Report
                </a>
            </div>
            <a href="estates.html" class="text-green-800 hover:text-green-900 transition duration-300">&larr; Back to Estates List</a>
        </nav>
    </header>

    <!-- Main container for the report -->
    <div class="container mx-auto p-4 md:p-8">
        <!-- Container where the estate data will be rendered -->
        <div id="selected-estate-container" class="grid grid-cols-1 gap-8">
             <!-- Content will be generated by JavaScript -->
        </div>
    </div>
    
    <!-- Modal for displaying policy details -->
    <div id="policyModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-2xl font-bold">Agricultural Policy Cross-Reference</h3>
                <button onclick="closePolicyModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="modalContent" class="space-y-4 overflow-y-auto pr-4 flex-grow">
                <!-- Modal content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Main script for application logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA STORE ---
            const estateData = {
                "id": "delima",
                "name": "Ladang Delima",
                "reportInfo": "Data based on PA Report (August 2025) & Agronomy Report 2/2025 (Visit Date: 30th September 2025).",
                "summaryMetrics": {
                    "area": {
                        "title": "Estate Area",
                        "lines": [
                            "Total Planted: 2,792.65 ha",
                            "Mature: 2,589.27 ha",
                            "Replanting: 203.38 ha"
                        ]
                    },
                    "yield": {
                        "title": "Yield/Ha (YTD Jul '25 vs Budget)",
                        "value": "5.03 / 7.02 MT",
                        "note": "28% lower than budget (PA Report)"
                    },
                    "cost": {
                        "title": "FFB Cost/Tonne (YTD Jul '25 vs Budget)",
                        "value": "RM 416.05 / RM 389.72",
                        "note": "7% higher than budget (PA Report)"
                    },
                    "labour": {
                        "title": "Labour Status",
                        "value": "Inadequate",
                        "note": "1:28 ha harvester ratio (PA Report)"
                    },
                     "pests": {
                        "title": "Key Pest Status",
                        "value": "Rats Under Control",
                        "note": "Avg 7% damage post-baiting (Aug '25)"
                    }
                },
                "keyMetrics": [
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-red-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z' /></svg>", "label": "Labour Ratio", "value": "1:18 ha (Short by 25 workers)" },
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-green-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' /></svg>", "label": "P&D Status", "value": "Rats Under Control (AR Pg. 52)" },
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-yellow-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M13 10V3L4 14h7v7l9-11h-7z' /></svg>", "label": "OER % (YTD Jul '25)", "value": "18.29%" },
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-blue-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z' /></svg>", "label": "Harvester Prod.", "value": "1.34 MT/md (Low)" },
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-purple-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z' /></svg>", "label": "Harvest Interval", "value": "~15 days (Improved)" },
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-teal-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17.657 18.343A8 8 0 016.343 7.029m11.314 11.314a8 8 0 01-11.314-11.314m2.121 13.435a2 2 0 01-2.828 0l-2.122-2.121a2 2 0 010-2.828l5.656-5.657a2 2 0 012.829 0l2.121 2.121a2 2 0 010 2.828l-5.657 5.657z' /></svg>", "label": "Manuring Status (Aug '25)", "value": "Delayed (77% Complete)" }
                ],
                "chartData": {
                    "production": {
                        "labels": ["2020", "2021", "2022", "2023", "2024", "2025 (YTD Aug)"],
                        "ffb": [16.57, 13.69, 12.43, 10.14, 11.70, 5.99],
                        "rainfall": [3551, 4221, 4565, 4918, 2453, 1909],
                        "note": "*Annual FFB Yield (YPH) and Rainfall. 2025 data as of August. Source: AR 2/2025, Pg. 60, 72, 73."
                    },
                    "ageProfile": {
                        "labels": ["Old Mature (>18Y)", "Prime Mature", "Replanting"],
                        "data": [61.9, 30.8, 7.3],
                        "title": "Ladang Delima - Palm Age Distribution (Aug 2025)",
                        "note": "*Source: PA Report 2/2025, Pg. 11."
                    }
                },
                "observations": [
                    "<b>Low FFB Yield & High Cost:</b> The estate's yield as of July 2025 is 28% below budget (PAR Pg. 37), and YTD August yield is 10% lower than the same period in 2024 (AR Pg. 60). This is the main performance issue, exacerbated by poor harvesting standards (overripe bunches). <span class='observation-ref'>(AR Pg. 17, 62)</span>",
                    "<b>Critical Labour Shortage:</b> The estate is short by 25 workers, with an inadequate harvester ratio of 1:28 ha. This strains operations, though harvesting intervals remain ~15 days. <span class='observation-ref'>(PAR Pg. 13-14)</span>",
                    "<b>Pest & Disease Status:</b> Rat infestation, previously high (19% in April), is now *under control* (average 7% damage) as of August 2025 following a baiting campaign (AR Pg. 52). Old bagworm damage was noted, but the infestation is not active (AR Pg. 51).",
                    "<b>Ground Cover & Upkeep (Improved):</b> Ground vegetation has \"greatly improved\" since the last visit, with *Nephrolepis* re-establishing and bare ground \"significantly reduced\" (AR Pg. 44, 48). Pruning quality has also \"significantly improved\" and is now satisfactory in most sub-blocks (AR Pg. 40).",
                    "<b>Manuring Program Delayed:</b> The 2025 fertilizer application is delayed due to late delivery from the supplier, with only 77% complete as of August. This could impact future crop production. <span class='observation-ref'>(AR Pg. 12, PAR Pg. 23)</span>",
                    "<b>Critical Water Management:</b> Proper water management is essential as 81% of the estate is peat soil and 79% is flood-prone (AR Pg. 74, 75). Main drains are free-flowing (AR Pg. 26), and the use of piezometers to maintain water levels (40-60cm) is a critical, ongoing initiative (PAR Pg. 27).",
                    "<b>Replanting Progress:</b> Replanting of 203.38 ha (P25J & P25K) is underway. <span class='observation-ref'>(PAR Pg. 43, AR Pg. 55)</span>"
                ],
                "reports": {
                    "plantation": {
                        "Executive Summary": "The estate's performance is hampered by low FFB yield and high production costs. Key issues are the labour shortage, severe rodent damage in specific fields, and delays in the manuring program. Positive developments include improved harvesting intervals (~15 days) and better water management initiatives in both mature and replanting areas. (Source: PAR, Pg. 49-52)",
                        "Area Statement": "Total planted area is 2,792.65 ha. This consists of 2,589.27 ha mature palms and 203.38 ha for the 2025 replanting program. The age profile is now 61.9% old mature, 30.8% prime, and 7.3% replanting. (Source: PAR, Pg. 11)",
                        "Labour Statement": "The estate is short by 25 workers, with a current force of 159 (1 worker:18 ha). The harvester ratio is 1:28 ha. 20 new workers are expected by the end of August. (Source: PAR, Pg. 13-14)",
                        "Staff Establishment": "The staff complement is adequate. It is recommended that personnel receive more training on peatland management to enhance competency. (Source: PAR, Pg. 15-16)",
                        "General Charges": "As of July 2025, expenditure was 30% lower than budget. Some seasonal overspending was noted on items like executive travel and MSPO charges, with justifications provided. (Source: PAR, Pg. 17-18)",
                        "Upkeep and Cultivation": "Selective weeding is ongoing, but over-spraying leading to bare ground is a concern. The 2025 manuring program is delayed. Rat damage is high in 8 fields. Drain desilting has been completed, and road grading was done in May. Progressive pruning is satisfactory. (Source: PAR, Pg. 19-34)",
                        "Harvesting and Collection": "The harvesting interval has improved to an average of 15 days, with 2 rounds per month. FFB quality is satisfactory, with over 90% ripe bunches. (Source: PAR, Pg. 35-36)",
                        "Crop Production": "As of July 2025, FFB production was 13,034.50 MT (5.03 t/ha), which is 28% below the YTD budget. The estate is projected to achieve 12.17 t/ha for the full year. (Source: PAR, Pg. 37)",
                        "Production Cost": "Ex-estate cost per tonne as of July 2025 was RM 416.05, which is 7% higher than budget, mainly due to low crop production. (Source: PAR, Pg. 41)",
                        "Replanting P25J & P25K (203.38 ha)": "Planting of 81.17 ha in P25J was completed in May 2025. The remaining 122.21 ha in P25K is ready for planting. Water management initiatives like piezometers and sandbag bunds are being implemented. (Source: PAR, Pg. 43-47)"
                    },
                    "agronomy": {
                        "Executive Summary": "Palm vigour has noticeably improved in most sub-blocks. Harvesting standards remain unsatisfactory with harvesting intervals exceeding the recommended 15 days. Pruning quality improved compared to the previous visit. Ground vegetation has improved, with many sub-blocks now well covered by Nephrolepis. The rat population is currently under control. Old bagworm damage was observed, but the infestation is under control. The 2024 yield was below potential, but the 2025 manuring program is delayed (77% complete as of Aug 2025) and requires close follow-up. (Source: AR, Pg. 4-6, 63-64)",
                        "Nutrient Inputs/Progress of Manuring": "The 2024 manuring program was 100% completed (Pg. 12). The 2025 program is 77% complete as of August 2025, but is facing delays, especially for Mixture B (66% complete) (Pg. 12). Lumpy fertilizer application was observed in P05A3 (Pg. 13-14). EFB application for 2025 is very slow, at only 6.06% completion (Pg. 14).",
                        "Agronomic Observation": "Crop recovery is mixed; while intervals are long (~15+ days), overripe bunches (15% in P05A1) and high loose fruits remain an issue (Pg. 17, 19). Palm vigour has clearly improved since January 2025, linked to better weather and drainage (Pg. 38). Main drains are well-maintained (Pg. 26). Pruning quality has significantly improved, with 48% of the 2nd round complete (Pg. 40). Ground cover is \"greatly improved\" with Nephrolepis now dominant (Pg. 44). Rat damage is now under control (avg 7% in Aug '25) (Pg. 52).",
                        "Yield Performance": "The 2024 yield of 11.70 MT/ha was an increase from 2023 (10.14 MT/ha) but still below potential (Pg. 60). Worryingly, the YTD August 2025 yield (5.99 MT/ha) is 10% lower than the same period in 2024 (6.66 MT/ha) (Pg. 60). However, the estate has good potential to improve yield due to noticeably better palm vigour (Pg. 63).",
                        "Fertilizer Recommendation": "The 2026 fertilizer program is outlined (Appendix 1a-c). The estate must closely follow up on delivery delays to minimize the gap between the scheduled program and actual application. (Source: AR, Pg. 65)"
                    },
                     "pinfosys": {
                        "summary": "Not Available."
                    }
                },
                "policy": "<div class='policy-item'><p class='font-semibold'>Pest Control</p><p class='text-sm text-gray-600'><b>Policy Ref: P&D-Rat-02b:</b> If a census reveals fresh rat damage above 20% in any field, a proper baiting campaign or application of 2 baits per palm is required to reduce the population. (Source: PAR, Pg. 24)</p></div><div class='policy-item'><p class='font-semibold'>Labour Management</p><p class='text-sm text-gray-600'><b>Policy Ref: LABOUR-RATIO-02:</b> The harvester-to-hectare ratio must be maintained at a level that ensures harvesting intervals do not exceed 15 days. Immediate recruitment is required to address shortfalls. (Source: PAR, Pg. 13)</p></div><div class='policy-item'><p class='font-semibold'>Ground Cover Management</p><p class='text-sm text-gray-600'><b>Policy Ref: WEED-GC-03:</b> Over-spraying with glyphosate leading to bare ground is not permitted. Promote establishment of soft grasses and Nephrolepis to improve soil health and moisture retention. (Source: PAR, Pg. 20)</p></div><div class='policy-item'><p class='font-semibold'>Water Management</p><p class='text-sm text-gray-600'><b>Policy Ref: PEAT-WM-01:</b> In peat areas, the water level must be maintained between 40cm and 60cm from the ground surface using appropriate structures like bunds or water gates. (Source: PAR, Pg. 27)</p></div>"
            };


            // --- GLOBAL VARIABLES ---
            let chartInstances = {};
            const container = document.getElementById('selected-estate-container');

            // --- FUNCTIONS ---
            function renderEstate() {
                container.innerHTML = createEstateHTML(estateData);
                setTimeout(() => {
                    initializeChartsForEstate(estateData);
                    populateInternalDropdowns(estateData);
                    attachEventListeners(estateData);
                }, 0);
            }

            function createEstateHTML(estate) {
                const summaryMetricsHTML = Object.values(estate.summaryMetrics).map(metric => {
                    const colorClass = metric.title.includes('Area') ? 'bg-blue-50 text-blue-800' : 
                                       metric.title.includes('Yield') ? 'bg-green-50 text-green-800' :
                                       metric.title.includes('Cost') ? 'bg-red-50 text-red-800' :
                                       metric.title.includes('Labour') ? 'bg-purple-50 text-purple-800' : 'bg-orange-50 text-orange-800';
                    if (metric.lines) {
                        return `<div class="p-4 rounded-lg ${colorClass}"><h3 class="font-semibold">${metric.title}</h3>${metric.lines.map(line => `<p class="text-sm">${line}</p>`).join('')}</div>`;
                    }
                    return `<div class="p-4 rounded-lg ${colorClass}"><h3 class="font-semibold">${metric.title}</h3><p class="text-2xl font-bold">${metric.value}</p><p class="text-xs text-gray-500 mt-1">${metric.note}</p></div>`;
                }).join('');

                const keyMetricsHTML = estate.keyMetrics.map(metric => `
                    <div class="flex items-center space-x-3 bg-gray-50 p-3 rounded-lg">
                        <div class="bg-gray-100 p-2 rounded-full">${metric.icon}</div>
                        <div><p class="text-sm text-gray-500">${metric.label}</p><p class="font-bold text-lg">${metric.value}</p></div>
                    </div>`).join('');

                const observationsHTML = estate.observations.map(obs => `<li class="ml-4">${obs}</li>`).join('');

                return `
                    <div class="bg-white p-6 rounded-lg shadow-lg animate-fade-in">
                        <h2 class="text-3xl font-bold mb-2 text-gray-900">${estate.name}</h2>
                        <p class="text-sm text-gray-500 mb-6 italic">${estate.reportInfo}</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 mb-8">${summaryMetricsHTML}</div>
                        <div class="mb-8"><h3 class="text-xl font-semibold mb-4 border-b pb-2">Key Metrics & Agronomic Status</h3><div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-4">${keyMetricsHTML}</div></div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                            <div><h3 class="text-xl font-semibold mb-2">Annual Yield & Rainfall</h3><div class="chart-container"><canvas id="prodChart-${estate.id}"></canvas></div><p class="text-xs text-center text-gray-500 mt-2">${estate.chartData.production.note}</p></div>
                            <div><h3 class="text-xl font-semibold mb-2">Palm Age Profile</h3><div class="pie-chart-container"><canvas id="ageChart-${estate.id}"></canvas></div><p class="text-xs text-center text-gray-500 mt-2">${estate.chartData.ageProfile.note}</p></div>
                        </div>
                        <div class="mb-8"><h3 class="text-xl font-semibold mb-2 border-b pb-2">Key Observations & Issues</h3><ul class="list-disc list-inside space-y-2 text-gray-700 mt-4">${observationsHTML}</ul></div>
                        <div class="mb-8 text-center"><button class="policy-modal-btn bg-green-800 text-white px-6 py-3 rounded-lg hover:bg-green-900 transition shadow-md">View Agricultural Policy Cross-Reference</button></div>
                        <div class="space-y-2">
                            <button data-dropdown-id="${estate.id}-plantation" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Plantation Advisory Report Details</button>
                            <div id="${estate.id}-plantation" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                            <button data-dropdown-id="${estate.id}-agronomy" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Agronomy Report Details</button>
                            <div id="${estate.id}-agronomy" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                             <button data-dropdown-id="${estate.id}-pinfosys" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Pinfosys Report Details</button>
                            <div id="${estate.id}-pinfosys" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                        </div>
                    </div>`;
            }

            function initializeChartsForEstate() {
                const prodCanvasId = `prodChart-${estateData.id}`;
                const ageCanvasId = `ageChart-${estateData.id}`;
                if (chartInstances[prodCanvasId]) chartInstances[prodCanvasId].destroy();
                if (chartInstances[ageCanvasId]) chartInstances[ageCanvasId].destroy();

                const prodCtx = document.getElementById(prodCanvasId)?.getContext('2d');
                if(prodCtx) {
                    chartInstances[prodCanvasId] = new Chart(prodCtx, {
                        type: 'bar',
                        data: {
                            labels: estateData.chartData.production.labels,
                            datasets: [
                                { label: 'FFB Yield (MT/Ha)', data: estateData.chartData.production.ffb, type: 'line', borderColor: '#ca8a04', backgroundColor: 'transparent', yAxisID: 'y-ffb', tension: 0.4 },
                                { label: 'Rainfall (mm)', data: estateData.chartData.production.rainfall, backgroundColor: '#3b82f6', yAxisID: 'y-rainfall' }
                            ]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, 'y-ffb': { type: 'linear', position: 'left', title: { display: true, text: 'FFB Yield (MT/Ha)' } }, 'y-rainfall': { type: 'linear', position: 'right', title: { display: true, text: 'Rainfall (mm)' }, grid: { drawOnChartArea: false } } } }
                    });
                }

                const ageCtx = document.getElementById(ageCanvasId)?.getContext('2d');
                if(ageCtx) {
                    chartInstances[ageCanvasId] = new Chart(ageCtx, {
                        type: 'pie',
                        data: {
                            labels: estateData.chartData.ageProfile.labels,
                            datasets: [{ data: estateData.chartData.ageProfile.data, backgroundColor: ['#ca8a04', '#eab308', '#fde047'], hoverOffset: 4 }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: estateData.chartData.ageProfile.title, font: { size: 16 } }, legend: { position: 'right' } } }
                    });
                }
            }
            
            function populateInternalDropdowns() {
                const agronomyDiv = document.getElementById(`${estateData.id}-agronomy`);
                const plantationDiv = document.getElementById(`${estateData.id}-plantation`);
                const pinfosysDiv = document.getElementById(`${estateData.id}-pinfosys`);

                if (agronomyDiv && estateData.reports.agronomy) {
                    agronomyDiv.innerHTML = Object.entries(estateData.reports.agronomy).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section.replace(/([A-Z])/g, ' $1').trim()}:</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                }
                if (plantationDiv && estateData.reports.plantation) {
                    plantationDiv.innerHTML = Object.entries(estateData.reports.plantation).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section.replace(/([A-Z])/g, ' $1').trim()}:</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                }
                 if (pinfosysDiv && estateData.reports.pinfosys) {
                    pinfosysDiv.innerHTML = `<p class="text-sm text-gray-600">${estateData.reports.pinfosys.summary}</p>`;
                }
            }

            function attachEventListeners() {
                container.querySelectorAll('.dropdown-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const id = event.currentTarget.dataset.dropdownId;
                        const content = document.getElementById(id);
                        content.classList.toggle('active');
                        event.currentTarget.classList.toggle('active');
                    });
                });
                container.querySelector('.policy-modal-btn')?.addEventListener('click', openPolicyModal);
            }

            renderEstate();
        });
        
        function openPolicyModal() {
            const modal = document.getElementById('policyModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            
            // This function needs access to the estateData object, 
            // which is defined inside the DOMContentLoaded event listener.
            // For this to work, we must ensure this function is called *after* estateData is defined,
            // or we need to move estateData to a broader scope.
            // Given the current structure, we'll assume estateData is in scope 
            // from the main script block when the button is clicked.
            
            // This is a potential issue: estateData is not globally scoped.
            // Let's redefine the click listener to pass the data.
            
            // We will re-attach the event listener inside the main script
            // to correctly capture the estateData scope.
            console.error("Policy modal button clicked, but data is out of scope.");
        }

        // Re-defining event listener attachment to correctly scope estateData
        document.addEventListener('DOMContentLoaded', () => {
            // ... (all the code from the main script block above) ...

            // --- Re-attach event listener for modal ---
            // This function is defined *inside* the DOMContentLoaded listener,
            // so it has access to the `estateData` variable.
            function openPolicyModalWithData() {
                const modal = document.getElementById('policyModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalContent = document.getElementById('modalContent');
                
                if (estateData && estateData.policy) {
                    modalTitle.innerText = `Agricultural Policy Cross-Reference: ${estateData.name}`;
                    modalContent.innerHTML = estateData.policy;
                    modal.classList.add('active');
                } else {
                    console.error("No policy data found for this estate.");
                }
            }
            
            // Find the button and attach the *correct* function
            const modalButton = document.querySelector('.policy-modal-btn');
            if (modalButton) {
                modalButton.removeEventListener('click', openPolicyModal); // Remove any old, incorrect listener
                modalButton.addEventListener('click', openPolicyModalWithData); // Add the new, correctly scoped listener
            }
        });

        function closePolicyModal() {
            document.getElementById('policyModal').classList.remove('active');
        }
    </script>
</body>
</html>
